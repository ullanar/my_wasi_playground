# How to Write a Rust WASI Component

## **Prerequisites**

Need to have: rustup, wkg, wasmtime

```bash
rustup target add wasm32-wasip2
```

---

## **Quick Start: Simple Component**

### **1. Create Project**
```bash
cargo new --lib my-component
cd my-component
```

### **2. Configure Cargo.toml**
```toml
[package]
name = "my-component"
version = "0.1.0"
edition = "2024"

[lib]
crate-type = ["cdylib"]

[dependencies]
wit-bindgen = "0.52"
```

### **3. Create WIT Definition**
```bash
mkdir wit
cat > wit/world.wit << 'EOF'
package myapp:component@0.1.0;

world hello {
    export hello: func() -> string;
}
EOF
```

### **4. Write Code**
```rust
// src/lib.rs
wit_bindgen::generate!({
    path: "wit",
});

struct Component;

impl Guest for Component {
    fn hello() -> String {
        "Hello from Rust WASI!".to_string()
    }
}

export!(Component);
```

### **5. Build**
```bash
cargo build --target wasm32-wasip2 --release
```

Output: `target/wasm32-wasip2/release/my_component.wasm`

---

## **Advanced: Custom WIT Interface with WASI Imports**

### **Project Structure**
```
my-component/
├── Cargo.toml
├── src/
│   └── lib.rs
└── wit/
    ├── world.wit
    └── deps/          # Generated by wkg (gitignored)
```

### **Step 1: Create WIT Definition**
```wit
// wit/world.wit
package myapp:component@0.1.0;

interface host {
    log: func(msg: string);
}

world my-world {
    include wasi:cli/imports@0.2.0;
    
    import host;
    export process: func(input: string) -> string;
    export compute: func(n: u32) -> u64;
}
```

### **Step 2: Fetch WIT Dependencies**
```bash
wkg wit fetch
```

This creates `wit/deps/` with resolved dependencies.

### **Step 3: Implement Component**
```rust
// src/lib.rs
wit_bindgen::generate!({
    path: "wit",
    generate_all,
});

use wasi::myapp::host;

struct Component;

impl Guest for Component {
    fn process(input: String) -> String {
        host::log(&format!("Processing: {}", input));
        format!("Processed: {}", input)
    }

    fn compute(n: u32) -> u64 {
        // Some computation
        (n as u64).pow(2)
    }
}

export!(Component);
```

### **Step 4: Build**
```bash
cargo build --target wasm32-wasip2 --release
```

---

## **wit-bindgen Options**

### **Basic**
```rust
wit_bindgen::generate!({
    path: "wit",
});
```

### **With WASI Dependencies**
```rust
wit_bindgen::generate!({
    path: "wit",
    generate_all,  // Generate bindings for all interfaces including WASI
});
```

### **Specifying World**
```rust
wit_bindgen::generate!({
    path: "wit",
    world: "my-world",
    generate_all,
});
```

---

## **Common Patterns**

### **Using Host Imports**
```rust
// WIT: import host { log: func(msg: string); }
use wasi::myapp::host;

fn do_something() {
    host::log("Hello from component");
}
```

### **Exporting Functions**
```rust
impl Guest for Component {
    fn my_export(input: String) -> String {
        // Implementation
        input.to_uppercase()
    }
}
```

### **Using std::time**
```rust
use std::time::Instant;

fn benchmark() -> u64 {
    let start = Instant::now();
    // ... work ...
    start.elapsed().as_nanos() as u64
}
```

---

## **Best Practices**

**Do**:
- Use `generate_all` when including WASI interfaces
- Run `wkg wit fetch` to resolve WIT dependencies
- Use `--release` for production builds
- Keep `wit/deps/` in .gitignore

**Don't**:
- Don't forget `crate-type = ["cdylib"]` in Cargo.toml
- Don't use the bundled `.wasm` file path directly in wit_bindgen (use `wit` directory)

---

## **Separate Build Directory (Optional)**

To avoid conflicts with IDE toolchain, use a separate target directory:

```toml
# .cargo/config.toml
[build]
target-dir = "target-wasm"
```

---

## **Troubleshooting**

**"package not found" for wasi:cli**:
- Run `wkg wit fetch` to download dependencies into `wit/deps/`

**"missing generate_all option"**:
- Add `generate_all` to wit_bindgen::generate! when using WASI includes

**"can't find crate for core"**:
- Run `rustup target add wasm32-wasip2`

---

## **Quick Reference**

```bash
# Add WASM target
rustup target add wasm32-wasip2

# Fetch WIT dependencies
wkg wit fetch

# Build
cargo build --target wasm32-wasip2 --release

# Inspect component
wasm-tools component wit target/wasm32-wasip2/release/my_component.wasm

# Run (if has wasi:cli/run)
wasmtime target/wasm32-wasip2/release/my_component.wasm
```
